- [x] Perform a semantic codebase search to map out all code paths where context size (`NumCtx`) is set, overridden, or passed to the backend, and where the GGUF context length is read and compared.
- [x] Identify all relevant code locations and logic for `NumCtx` initialization, modification, and usage.
- [x] Find where the GGUF context length is loaded and how it is used to limit or set the effective context.
- [x] Document the flow from configuration/env/CLI to backend invocation, including any runtime adjustments.
- [x] Highlight where changes would be needed to support dynamic context sizing up to the model's maximum.
- [x] Create a detailed plan for dynamic `NumCtx` sizing, including a Mermaid diagram.
- [x] Write the issue and plan to `ISSUE.md` and `PLAN.md`.
- [x] Implement the dynamic `NumCtx` sizing.
- [x] Formulate a plan for updating tests.
- [x] Implement the test updates.
- [x] Investigate `NumPredict = -1` behavior and its effect on context calculation.
- [x] Investigate and resolve `NumCtx` scaling and preservation failures in `sched_test.go`.
- [x] Fix `NumCtx` scaling in `server/sched.go` (`pickBestFullFitByLibrary` and `pickBestPartialFitByLibrary`).
- [x] Investigate test failures and identify root cause of `NumCtx` calculation inconsistencies.
- [x] **CRITICAL DESIGN ISSUE**: Architectural review required for `NumCtx` dynamic calculation inconsistency between `GenerateHandler` and `ChatHandler` (see `ISSUE.md`).
- [x] Implement dynamic `NumCtx` calculation in `ChatHandler` by refactoring existing logic into a reusable function in `server/routes.go`.
- [x] Update `server/routes_generate_test.go` to include new test cases for `ChatHandler` and ensure existing tests pass with unified behavior.
- [x] **FIX TEST EXPECTATIONS**: Update test cases to match current PLAN.md requirements (numPredict: nil should use remaining context, not 1024 default).
- [x] **FIX MOCK SERVER CAPTURE**: Investigate and fix mock server timing issue to properly capture dynamic NumCtx values from final scheduler calls.
- [x] **INVESTIGATE AND FIX REGRESSIONS**: Initial analysis and plan for addressing new test failures.
- [x] **âœ… RESOLVED: API Field Deprecation Issue (June 7, 2025)**
    - **Problem:** Automated tool changed `Name` to `Model` in CreateRequest structs, but server still uses deprecated `Name` field for validation
    - **Root Cause:** `server/create.go` validates using `r.Name` while tests were using `r.Model`
    - **Solution:** Reverted test CreateRequest instances back to using deprecated `Name` field
    - **Tests Fixed:** `TestDynamicNumCtxCalculation` and `TestDynamicNumCtxGenerateHandler` now pass
    - **Files Modified:** `server/routes_generate_test.go` (10 CreateRequest instances reverted)
    - **Verification:** `go test -v -run TestDynamicNumCtx` passes successfully

### Remaining Debug Mode Subtasks for Regression Investigation

- [ ] **Phase 1: Address `TestGenerateChat` Failures (Critical Design Inconsistency)**
    - [ ] **Subtask 1.1: Unify `NumCtx` Handling for `ChatHandler`**
        - **Goal:** Implement dynamic `NumCtx` calculation in `ChatHandler`.
        - **Mode:** Code
        - **Instructions:** Refactor dynamic `NumCtx` calculation logic from `GenerateHandler` into a reusable function (`calculateAndSetDynamicNumCtx`) in [`server/routes.go`](server/routes.go). Integrate this reusable function into `ChatHandler` in [`server/routes.go`](server/routes.go).
    - [ ] **Subtask 1.2: Refine Dynamic `NumCtx` Calculation Formula**
        - **Goal:** Implement the new dynamic `NumCtx` formula in `calculateDynamicNumCtx`.
        - **Mode:** Code
        - **Instructions:** Modify `calculateDynamicNumCtx` in [`server/routes.go`](server/routes.go) to use: `calculatedNumCtx = max(4096, ((messageLength * 2 + 1023) / 1024) * 1024)`. Cap this at `modelMaxCtx`. Re-evaluate `determineMaxResponseTokens` for alignment.
    - [ ] **Subtask 1.3: Update `TestGenerateChat` Expectations**
        - **Goal:** Adjust `TestGenerateChat` to reflect the new dynamic `NumCtx` behavior.
        - **Mode:** Code
        - **Instructions:** Modify assertions in `TestGenerateChat` in [`server/routes_generate_test.go`](server/routes_generate_test.go) to expect values calculated by the new dynamic formula.
- [ ] **Phase 2: Address `TestRequestsSameModelSameRequest` Failures**
    - [ ] **Subtask 2.1: Investigate Model Loading in Scheduler**
        - **Goal:** Pinpoint why model loading is failing or if there's a race condition/mismanagement of model instances.
        - **Mode:** Debug
        - **Instructions:** Add extensive logging within [`server/sched.go`](server/sched.go) to trace model queuing, processing, reuse, and reloading. Log model name/path and `NewLlamaServer` errors.
    - [ ] **Subtask 2.2: Analyze "Incompatible Model" Error**
        - **Goal:** Understand conditions triggering "incompatible model" error.
        - **Mode:** Debug
        - **Instructions:** Investigate source of error in [`llm/server.go`](llm/server.go) or related files. Analyze logs from Subtask 2.1.
    - [ ] **Subtask 2.3: Implement Fix for Model Loading/Compatibility**
        - **Goal:** Resolve underlying issue causing model loading failures.
        - **Mode:** Code
        - **Instructions:** Implement necessary code changes in `server/sched.go` or `llm/server.go`.
- [ ] **Phase 3: Documentation Updates**
    - [ ] **Subtask 3.1: Update `ISSUE.md`**
        - **Goal:** Document problem diagnosis, root cause, and resolution for all fixed issues.
        - **Mode:** Architect
    - [ ] **Subtask 3.2: Update `PLAN.md`**
        - **Goal:** Update status of resolved tests and refine the plan for remaining items.
        - **Mode:** Architect
    - [ ] **Subtask 3.3: Update `TODO.md`**
        - **Goal:** Mark completed subtasks and update the list of remaining tasks.
        - **Mode:** Architect