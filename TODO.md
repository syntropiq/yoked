- [x] Perform a semantic codebase search to map out all code paths where context size (`NumCtx`) is set, overridden, or passed to the backend, and where the GGUF context length is read and compared.
- [x] Identify all relevant code locations and logic for `NumCtx` initialization, modification, and usage.
- [x] Find where the GGUF context length is loaded and how it is used to limit or set the effective context.
- [x] Document the flow from configuration/env/CLI to backend invocation, including any runtime adjustments.
- [x] Highlight where changes would be needed to support dynamic context sizing up to the model's maximum.
- [x] Create a detailed plan for dynamic `NumCtx` sizing, including a Mermaid diagram.
- [x] Write the issue and plan to `ISSUE.md` and `PLAN.md`.
- [x] Implement the dynamic `NumCtx` sizing.
- [x] Formulate a plan for updating tests.
- [x] Implement the test updates.
- [x] Investigate `NumPredict = -1` behavior and its effect on context calculation.
- [x] Investigate and resolve `NumCtx` scaling and preservation failures in `sched_test.go`.
- [x] Fix `NumCtx` scaling in `server/sched.go` (`pickBestFullFitByLibrary` and `pickBestPartialFitByLibrary`).
- [x] Investigate test failures and identify root cause of `NumCtx` calculation inconsistencies.
- [x] **CRITICAL DESIGN ISSUE**: Architectural review required for `NumCtx` dynamic calculation inconsistency between `GenerateHandler` and `ChatHandler` (see `ISSUE.md`).
- [x] Implement dynamic `NumCtx` calculation in `ChatHandler` by refactoring existing logic into a reusable function in `server/routes.go`.
- [x] Update `server/routes_generate_test.go` to include new test cases for `ChatHandler` and ensure existing tests pass with unified behavior.
- [x] **FIX TEST EXPECTATIONS**: Update test cases to match current PLAN.md requirements (numPredict: nil should use remaining context, not 1024 default).
- [x] **FIX MOCK SERVER CAPTURE**: Investigate and fix mock server timing issue to properly capture dynamic NumCtx values from final scheduler calls.
- [x] **INVESTIGATE AND FIX REGRESSIONS**: Initial analysis and plan for addressing new test failures.

### Debug Mode Subtasks for Regression Investigation

- [x] **Debug Subtask 1: `TestNumCtxNotScaledByNumParallel` Investigation**
    - **Goal:** Determine why `TestNumCtxNotScaledByNumParallel` is failing.
    - **Instructions:** Add extensive logging in `server/sched.go` to trace `NumCtx` and `numParallel` values. Run the test in isolation and report detailed log output.
    - **Resolution:** Fixed test expectations from 2048 to 4096 to match correct dynamic NumCtx calculation. Test was failing due to outdated expectations, not system bugs.
- [x] **Debug Subtask 2: `TestDynamicNumCtxGenerateHandler` Investigation**
    - **Goal:** Understand why subtests within `TestDynamicNumCtxGenerateHandler` are failing.
    - **Instructions:** Add logging in `server/routes.go` to trace `NumCtx` calculation. Enhance mock server in `server/routes_generate_test.go` to log received `api.Options`. Run tests and report discrepancies.
    - **Resolution:** Fixed two critical issues: (1) Corrected `determineMaxResponseTokens` function to use remaining context instead of fixed 1024 default when `numPredict=-1`, matching existing behavior. (2) Fixed mock server capture logic by implementing proper `loadFn` pattern that calls `newMockServer` to capture final scheduler options. Both `TestDynamicNumCtxGenerateHandler` and `TestDynamicNumCtxCalculation` now pass successfully.
- [x] **Debug Subtask 3: `TestCreate*` Tests Investigation**
    - **Goal:** Pinpoint the exact cause of failures in `TestCreate*` tests.
    - **Instructions:** Add logging in `server/create.go` to trace model metadata flow. Log expected vs. actual values. Run tests individually and report specific discrepancies.
    - **Resolution:** Identified and fixed API deprecated field mismatch. Server code was using `r.Model` (new field) while tests used `r.Name` (deprecated field). Reverted [`server/create.go:58`](server/create.go:58) to use `r.Name` for backward compatibility. `TestCreateFromBin` now passes. Issue documented in `ISSUE.md` for future reference.
- [ ] **Debug Subtask 4: `TestManifestCaseSensitivity` Investigation**
    - **Goal:** Determine the root cause of `TestManifestCaseSensitivity` failure.
    - **Instructions:** Add logging in manifest parsing logic (`model/` or `parser/`) to show how model names/paths are compared. Run the test and report comparison logic and values.
- [ ] **Debug Subtask 5: `TestGenerateChat (messages_with_interleaved_system)` Investigation**
    - **Goal:** Understand why `TestGenerateChat (messages_with_interleaved_system)` is failing.
    - **Instructions:** Add logging in `server/routes.go` (`ChatHandler`) and `server/prompt.go` (`chatPrompt`) to trace prompt content, token counts, and truncation behavior. Run the test and report.
- [ ] **Debug Subtask 6: `TestRequestsSameModelSameRequest` Investigation**
    - **Goal:** Determine why `TestRequestsSameModelSameRequest` is failing.
    - **Instructions:** Add logging in `server/sched.go` to trace concurrent request handling for the same model. Log `NumCtx` and `numParallel` values. Run the test and report unexpected behavior.
- [ ] **Debug Subtask 7: `TestDelete`, `TestList`, `TestShow` Investigation**
    - **Goal:** Confirm if these failures are secondary to `TestCreate*` issues, or independent problems.
    - **Instructions:** Run tests after `TestCreate*` investigation. If still failing, add logging to their handlers in `server/routes.go` to trace model lookup/deletion/listing. Report errors.