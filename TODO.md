- [x] Perform a semantic codebase search to map out all code paths where context size (`NumCtx`) is set, overridden, or passed to the backend, and where the GGUF context length is read and compared.
- [x] Identify all relevant code locations and logic for `NumCtx` initialization, modification, and usage.
- [x] Find where the GGUF context length is loaded and how it is used to limit or set the effective context.
- [x] Document the flow from configuration/env/CLI to backend invocation, including any runtime adjustments.
- [x] Highlight where changes would be needed to support dynamic context sizing up to the model's maximum.
- [x] Create a detailed plan for dynamic `NumCtx` sizing, including a Mermaid diagram.
- [x] Write the issue and plan to `ISSUE.md` and `PLAN.md`.
- [x] Implement the dynamic `NumCtx` sizing.
- [x] Formulate a plan for updating tests.
- [x] Implement the test updates.
- [x] Investigate `NumPredict = -1` behavior and its effect on context calculation.
- [x] Investigate and resolve `NumCtx` scaling and preservation failures in `sched_test.go`.
- [x] Fix `NumCtx` scaling in `server/sched.go` (`pickBestFullFitByLibrary` and `pickBestPartialFitByLibrary`).
- [x] Investigate test failures and identify root cause of `NumCtx` calculation inconsistencies.
- [x] **CRITICAL DESIGN ISSUE**: Architectural review required for `NumCtx` dynamic calculation inconsistency between `GenerateHandler` and `ChatHandler` (see `ISSUE.md`).
- [x] Implement dynamic `NumCtx` calculation in `ChatHandler` by refactoring existing logic into a reusable function in `server/routes.go`.
- [x] Update `server/routes_generate_test.go` to include new test cases for `ChatHandler` and ensure existing tests pass with unified behavior.
- [x] **FIX TEST EXPECTATIONS**: Update test cases to match current PLAN.md requirements (numPredict: nil should use remaining context, not 1024 default).
- [x] **FIX MOCK SERVER CAPTURE**: Investigate and fix mock server timing issue to properly capture dynamic NumCtx values from final scheduler calls.
- [x] **INVESTIGATE AND FIX REGRESSIONS**: Initial analysis and plan for addressing new test failures.
- [x] **✅ RESOLVED: API Field Deprecation Issue (June 7, 2025)**
    - **Problem:** Automated tool changed `Name` to `Model` in CreateRequest structs, but server still uses deprecated `Name` field for validation
    - **Root Cause:** `server/create.go` validates using `r.Name` while tests were using `r.Model`
    - **Solution:** Reverted test CreateRequest instances back to using deprecated `Name` field
    - **Tests Fixed:** `TestDynamicNumCtxCalculation` and `TestDynamicNumCtxGenerateHandler` now pass
    - **Files Modified:** `server/routes_generate_test.go` (10 CreateRequest instances reverted)
    - **Verification:** `go test -v -run TestDynamicNumCtx` passes successfully

### Remaining Debug Mode Subtasks for Regression Investigation

- [x] **New Performance Diagnosis Plan: "Time to First Token" Degradation (June 7, 2025)**
    - [x] **Subtask 3.1: Client-side "Time to First Token" Stopwatch**
        - **Goal:** Measure and display "time to first token" in client's `--verbose` output.
        - **Mode:** Code
        - **Status:** ✅ COMPLETED - Added timing measurement to both `generate` and `chat` functions in [`cmd/cmd.go`](cmd/cmd.go). Implemented stopwatch that starts when request is sent and stops when first token is received. Displays duration in `--verbose` output as "Time to first token: Xms".
        - **Instructions:** Identify relevant client-side verbose output location (e.g., `cmd` or `app` directories). Implement a stopwatch that starts when the request is sent and stops when the first token is received. Display this duration in the `--verbose` output.
    - [x] **Subtask 3.2: Server-side Context Size and Truncation Logging**
        - **Goal:** Log `num_ctx` per message and truncation warnings in server logs.
        - **Mode:** Code
        - **Status:** ✅ COMPLETED - Enhanced `calculateAndSetDynamicNumCtx` in [`server/routes.go`](server/routes.go) with detailed logging including request ID, model name, message length, and dynamic NumCtx calculation. Added comprehensive truncation logging to `chatPrompt` in [`server/prompt.go`](server/prompt.go) with before/after truncation details.
        - **Instructions:** Enhance `calculateAndSetDynamicNumCtx` in [`server/routes.go`](server/routes.go) to log `dynamicNumCtx` after calculation, including request ID and model name. Identify prompt truncation logic (likely `server/prompt.go`). Add log entries *before* truncation (original message length, `NumCtx` limit) and *after* truncation (final truncated length, amount lopped off).
    - [ ] **Subtask 3.3: Verification of New Logging**
        - **Goal:** Confirm new logging is accurate and provides expected diagnostic information.
        - **Mode:** Debug
        - **Instructions:** Run a user acceptance test scenario that reproduces "time to first token" degradation and involves context growth/truncation. Review client-side `--verbose` output and server logs.
    - [ ] **Subtask 3.4: Update Documentation (Final)**
        - **Goal:** Document the findings and resolution of the "time to first token" issue.
        - **Mode:** Architect
        - **Instructions:** Update `ISSUE.md` with the diagnosis and resolution. Update `PLAN.md` with the completed subtasks. Update `TODO.md` to mark these new tasks as completed.

- [x] **Phase 1: Address `TestGenerateChat` Failures (Critical Design Inconsistency)**
    - [x] **Subtask 1.1: Unify `NumCtx` Handling for `ChatHandler`**
        - **Goal:** Implement dynamic `NumCtx` calculation in `ChatHandler`.
        - **Mode:** Code
        - **Status:** ✅ COMPLETED - `ChatHandler` already had dynamic NumCtx calculation implemented via `calculateAndSetDynamicNumCtx` function
        - **Instructions:** Refactor dynamic `NumCtx` calculation logic from `GenerateHandler` into a reusable function (`calculateAndSetDynamicNumCtx`) in [`server/routes.go`](server/routes.go). Integrate this reusable function into `ChatHandler` in [`server/routes.go`](server/routes.go).
    - [x] **Subtask 1.2: Refine Dynamic `NumCtx` Calculation Formula**
        - **Goal:** Implement the new dynamic `NumCtx` formula in `calculateDynamicNumCtx`.
        - **Mode:** Code
        - **Status:** ✅ COMPLETED - Updated `calculateDynamicNumCtx` function with new formula: `baseNumCtx = messageLength * 2`, round to 1024, apply floor of 4096, cap at modelMaxCtx
        - **Instructions:** Modify `calculateDynamicNumCtx` in [`server/routes.go`](server/routes.go) to use: `calculatedNumCtx = max(4096, ((messageLength * 2 + 1023) / 1024) * 1024)`. Cap this at `modelMaxCtx`. Re-evaluate `determineMaxResponseTokens` for alignment.
    - [x] **Subtask 1.3: Update `TestGenerateChat` Expectations**
        - **Goal:** Adjust `TestGenerateChat` to reflect the new dynamic `NumCtx` behavior.
        - **Mode:** Code
        - **Status:** ✅ COMPLETED - Updated test expectations in `TestDynamicNumCtxCalculation`, `TestDynamicNumCtxGenerateHandler`, and `TestNumCtxNotScaledByNumParallel` to reflect new formula calculations
        - **Instructions:** Modify assertions in `TestGenerateChat` in [`server/routes_generate_test.go`](server/routes_generate_test.go) to expect values calculated by the new dynamic formula.
- [x] **Phase 2: Address `TestRequestsSameModelSameRequest` Failures**
    - [x] **Subtask 2.1: Investigate Model Loading in Scheduler**
        - **Goal:** Pinpoint why model loading is failing or if there's a race condition/mismanagement of model instances.
        - **Mode:** Debug
        - **Status:** ✅ COMPLETED - Added extensive logging to `needsReload` function and identified root cause: NumCtx normalization inconsistency
        - **Instructions:** Add extensive logging within [`server/sched.go`](server/sched.go) to trace model queuing, processing, reuse, and reloading. Log model name/path and `NewLlamaServer` errors.
    - [x] **Subtask 2.2: Analyze "Incompatible Model" Error**
        - **Goal:** Understand conditions triggering "incompatible model" error.
        - **Mode:** Debug
        - **Status:** ✅ COMPLETED - Determined that the "incompatible model" error was not the issue; the problem was in `needsReload` function logic
        - **Instructions:** Investigate source of error in [`llm/server.go`](llm/server.go) or related files. Analyze logs from Subtask 2.1.
    - [x] **Subtask 2.3: Implement Fix for Model Loading/Compatibility**
        - **Goal:** Resolve underlying issue causing model loading failures.
        - **Mode:** Code
        - **Status:** ✅ COMPLETED - Fixed NumCtx normalization bug in `needsReload` function by normalizing both `optsExisting.NumCtx` and `optsNew.NumCtx` by `runner.numParallel`
        - **Instructions:** Implement necessary code changes in `server/sched.go` or `llm/server.go`.
- [x] **Phase 3: Documentation Updates**
    - [x] **Subtask 3.1: Update `ISSUE.md`**
        - **Goal:** Document problem diagnosis, root cause, and resolution for all fixed issues.
        - **Mode:** Architect
    - [x] **Subtask 3.2: Update `PLAN.md`**
        - **Goal:** Update status of resolved tests and refine the plan for remaining items.
        - **Mode:** Architect
    - [x] **Subtask 3.3: Update `TODO.md`**
            - **Goal:** Mark completed subtasks and update the list of remaining tasks.
            - **Mode:** Architect

## Cache Optimization Implementation (June 7, 2025)

- [x] **Fix Premature Context Eviction in Cache Shifting**
    - **Problem:** `ShiftCacheSlot` was using `numKeep=0` by default, causing aggressive truncation of context even when dynamic `numCtx` had sufficient space
    - **Root Cause:** `numKeep` was set to `req.Options.NumKeep` (defaults to 0) instead of aligning with dynamic context sizing
    - **Solution:** Modified [`runner/ollamarunner/runner.go:634`](runner/ollamarunner/runner.go:634) to set `numKeep: s.cache.numCtx` instead of `int32(req.Options.NumKeep)`
    - **Effect:** Cache shifting now preserves the full dynamic context window, preventing premature eviction of relevant context
    - **Status:** ✅ COMPLETED - Change implemented and ready for testing